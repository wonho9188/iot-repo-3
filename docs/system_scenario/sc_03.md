SC_03. 분류 작업 종료 및 비상정지 시나리오
트리거:
관리자가 입고종료/비상정지 버튼 클릭 또는 10초간 물품 미감지
참여자:
GUI(PyQt6), API Server(Flask), Service Layer, TCP Handler, Sort Controller(ESP32)
Flow:
A. 정상 종료 시나리오:
1. 종료 명령 발생

관리자가 GUI에서 "분류종료" 버튼 클릭
또는 Sort Controller가 10초간 IR 센서 미감지 상태 감지
GUI에서 종료 버튼 클릭 시 Flask REST API 요청 전송: POST /api/inbound/stop
Sort Controller에서 자동 감지 시 이벤트 메시지를 TCP Handler로 전송

2. 하드웨어 상태 확인

Service Layer는 하드웨어 상태 확인 명령 생성
TCP Handler는 Sort Controller로 상태 확인 메시지 전송
Sort Controller는 물리적 상태 확인 후 응답 메시지 전송

3. 상태 일관성 검사 및 동기화

물리적 비상정지 활성화 감지 시:

시스템 상태를 "EMERGENCY_STOP"으로 설정
Socket.IO를 통해 GUI에 "물리적 비상정지 버튼이 활성화되어 있습니다" 메시지 전송 (1초 후 자동 소멸)
요청 중단


모터 작동 상태와 시스템 상태 비교:

모터 비작동 + 시스템 "RUNNING" 상태: → 시스템 상태를 "STOPPED"으로 동기화, 로그에 불일치 기록
모터 작동 + 시스템 "RUNNING" 아닌 상태: → 시스템 상태를 "RUNNING"으로 동기화, 로그에 불일치 기록



4. 시스템 상태 확인

Service Layer는 (동기화된) 현재 분류기 상태 확인
분류기 상태가 "RUNNING"이 아닌 경우:

Socket.IO를 통해 GUI에 "분류기가 작동 중이 아닙니다" 메시지 전송 (1초 후 자동 소멸)
요청 중단


분류기 상태가 "RUNNING"인 경우 다음 단계로 진행

5. 대기 물품 확인

Service Layer는 현재 메모리에 저장된 대기 물품 수 확인
대기 물품이 있는 경우(값 > 0):

Socket.IO를 통해 GUI에 "아직 처리 중인 물품이 있습니다" 경고 메시지 전송 (1초 후 자동 소멸)
종료 작업 중단, 입고 상태 유지


대기 물품이 없는 경우(값 = 0) 다음 단계로 진행

6. 하드웨어 제어 명령 전송

TCP Handler는 Sort Controller로 정지 명령 메시지 전송
Sort Controller는 명령 수신 후 다음 작업 수행:

컨베이어 벨트 모터 정지 (모터 제어 핀을 LOW로 설정)
바코드 스캐너 비활성화 (스캐너 전원 제어 핀을 LOW로 설정)
모든 센서 비활성화 (필요에 따라)


Sort Controller는 정지 완료 후 성공 응답 메시지 전송

7. GUI 상태 업데이트

TCP Handler는 응답을 수신하여 Service Layer로 전달
응답이 성공적인 경우에만 Service Layer는 분류기 상태 업데이트:

분류기 상태를 "STOPPED"으로 변경
Socket.IO를 통해 GUI로 상태 업데이트 전송


GUI는 다음과 같이 업데이트:

상태 표시를 "분류 종료"로 변경 (회색)
"분류시작" 버튼 활성화
"분류종료" 버튼 비활성화



B. 비상정지 시나리오:
1. 비상정지 명령 발생

관리자가 GUI에서 "비상정지" 버튼 클릭
또는 물리적 비상정지 버튼 작동
GUI에서 비상정지 버튼 클릭 시 Flask REST API 요청 전송: POST /api/emergency/stop
물리적 버튼 작동 시 Sort Controller가 직접 감지하여 이벤트 메시지 전송

2. 하드웨어 상태 확인 (GUI 비상정지의 경우만)

Service Layer는 하드웨어 상태 확인 명령 생성
TCP Handler는 Sort Controller로 상태 확인 메시지 전송
Sort Controller는 물리적 상태 확인 후 응답 전송
물리적 비상정지가 이미 활성화되어 있으면:

분류기 상태를 "EMERGENCY_STOP"으로 설정
Socket.IO를 통해 GUI에 "물리적 비상정지 버튼이 이미 활성화되어 있습니다" 메시지 전송 (1초 후 자동 소멸)
소프트웨어 비상정지 명령 계속 진행 (안전 강화)



3. 비상정지 명령 처리

모든 분류기 상태에서 즉시 비상정지 명령 생성
TCP Handler는 Sort Controller로 최우선 순위 비상정지 명령 전송

4. 비상정지 실행

Sort Controller는 즉시 다음 작업 수행:

컨베이어 벨트 모터 즉시 정지
바코드 스캐너 전원 차단
모든 서보모터 정지
필요한 경우 경고음 발생


정지 완료 후 응답 메시지 전송

5. 비상정지 상태 기록

TCP Handler가 응답을 수신하여 Service Layer로 전달
응답이 성공적인 경우에만 Service Layer는 다음 작업 수행:

분류기 상태를 "EMERGENCY_STOP"으로 변경
마지막 상태(last_state)를 "EMERGENCY_STOP"으로 기록
Socket.IO를 통해 GUI에 비상정지 알림 전송



6. GUI 상태 업데이트

GUI는 비상정지 상태 반영:

상태 표시를 "비상정지"로 변경 (빨간색 배경)
"분류시작" 버튼 비활성화
"분류종료" 버튼 비활성화
"비상정지" 버튼 강조 표시
비상정지 해제 관련 안내 메시지 표시



선택 분기점:

물리적 비상정지 상태: 활성화되어 있으면 시스템 상태 "EMERGENCY_STOP"으로 설정, 요청 처리 방향 결정
모터/시스템 상태 일치 여부: 상태 불일치 시 물리적 상태 기준으로 동기화
분류기 동기화 상태: "RUNNING"이면 정상 종료 절차, 다른 상태면 요청 무시
대기 물품 존재: 대기 물품이 있으면 정상 종료 불가, 없으면 정상 종료 진행
비상정지 소스: GUI 비상정지 버튼 또는 물리적 비상정지 버튼에 따라 처리 경로 다름

예외 상황:

물리적 비상정지 활성화: 물리적 비상정지 버튼은 하드웨어 회로로 직접 모터 전원 차단
TCP 전송 실패: 서버-분류기 통신 실패 시에도 물리적 비상정지 버튼은 독립적으로 작동
상태 불일치 감지: 시스템 상태와 하드웨어 실제 상태 불일치 시 로그 기록 및 자동 동기화
자동 종료 불일치: 카운터와 실제 물품 수가 불일치할 경우 로그에 기록 및 관리자 확인 필요

자동 소멸 메시지(auto_dismiss: 1000):

"물리적 비상정지 버튼이 활성화되어 있습니다"
"분류기가 작동 중이 아닙니다"
"아직 처리 중인 물품이 있습니다"