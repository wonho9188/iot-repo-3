SC_01. 분류 작업 시작 시나리오
트리거:
관리자가 GUI에서 분류시작 버튼을 누름
참여자:
GUI(PyQt6), API Server(Flask), Service Layer, TCP Handler, Sort Controller(ESP32)
Flow:
1. 분류 시작 명령 전송

관리자가 GUI 장치관리 페이지에서 "분류시작" 버튼 클릭
GUI는 Flask REST API 요청을 생성: POST /api/inbound/start
Flask API Server가 이 요청을 수신하고 Service Layer로 전달

2. 하드웨어 상태 확인

Service Layer는 먼저 하드웨어 상태 확인 명령 생성
TCP Handler는 Sort Controller로 상태 확인 메시지 전송
Sort Controller는 다음 항목들을 확인:

물리적 비상정지 버튼 입력 핀 상태 (HIGH=정상/해제됨, LOW=비상정지 활성화/눌림)
컨베이어 모터 활성화 신호 확인 (HIGH=작동 중, LOW=정지)


Sort Controller는 확인 결과를 응답 메시지로 TCP Handler에 전송

3. 시스템 상태 종합 판단

Service Layer는 Sort Controller의 응답과 자체 메모리에 저장된 상태를 종합적으로 판단:

물리적 비상정지가 활성화된 경우:

분류기 상태를 "EMERGENCY_STOP"으로 설정
Socket.IO를 통해 GUI에 알림 메시지 전송
요청 중단 (물리적 비상정지는 하드웨어 해제 필요)


모터가 이미 작동 중인 경우:

분류기 상태를 "RUNNING"으로 설정 (상태 동기화)
Socket.IO를 통해 GUI에 "이미 작동 중입니다" 메시지 전송
요청 중단 (이미 작동 중이므로 시작 명령 불필요)


모터 정지 상태이고 서버 메모리의 분류기 상태가 "EMERGENCY_STOP"인 경우:

비상상황 확인 절차 진행 (4단계)


그 외 모든 경우 (장치가 정상이고 작동 중이 아님):

분류기 상태를 "STOPPED"으로 설정
다음 단계(5단계)로 진행





4. 비상정지 확인 절차 (필요 시)

분류기 상태가 "EMERGENCY_STOP"이고 물리적 버튼이 해제된 상태인 경우:

Socket.IO를 통해 GUI에 "비상상황을 해결하셨습니까?" 확인 메시지 전송
GUI에 팝업 표시 (YES/NO 버튼 포함)
YES 선택:

분류기 상태를 "STOPPED"으로 변경
다음 단계로 진행


NO 선택:

Socket.IO를 통해 GUI에 "비상 상황 해결 후 다시 시도하세요" 메시지 전송
요청 중단





5. 하드웨어 제어 명령 전송

Service Layer는 TCP Handler에 명령 요청
TCP Handler는 Sort Controller로 분류 시작 명령 전송
Sort Controller(ESP32)는 명령 수신 후 다음 작업 수행:

물리적 비상정지 상태 재확인 (안전 조치)
컨베이어 벨트 모터 가동 (모터 제어 핀을 HIGH로 설정)
바코드 스캐너 활성화 (스캐너 전원 제어 핀을 HIGH로 설정)
모든 센서 활성화 (센서들의 인터럽트 활성화)


ESP32는 성공 응답 메시지 전송

6. GUI 상태 업데이트

TCP Handler는 응답을 수신하여 Service Layer로 전달
응답이 성공적인 경우에만 Service Layer는 분류기 상태 업데이트:

분류기 상태를 "RUNNING"으로 변경
Socket.IO를 통해 GUI로 상태 업데이트 전송


GUI는 다음과 같이 업데이트:

상태 표시를 "작동 중"으로 변경 (녹색)
"분류시작" 버튼 비활성화
"분류종료" 버튼 활성화
입고 수량을 0으로 초기화



선택 분기점:

물리적 비상정지 버튼 상태: 눌린 상태면 모든 작업 거부(1초 알림), 해제된 상태면 계속 진행
모터 작동 상태: 이미 작동 중이면 요청 무시(1초 알림), 그렇지 않으면 계속 진행
서버에 저장된 비상정지 상태: "EMERGENCY_STOP"이면 확인 절차 진행, "STOPPED"이면 바로 시작
관리자 확인 응답: YES면 상태 리셋 후 시작, NO면 알림 후(1초) 작업 중단

예외 상황:

논리적 상태 불일치: 모터 작동 중 + 비상정지 상태와 같은 논리적 모순 발견 시 자동 동기화
물리적 비상정지 활성화: 물리적 비상정지 버튼이 눌린 상태에서는 어떤 소프트웨어 명령도 무시, 버튼 해제 필요
TCP 전송 실패: Socket.IO를 통해 GUI에 "하드웨어 연결 오류" 메시지 전송
하드웨어 응답 없음: 10초 대기 후 타임아웃 처리, 분류기 상태를 "STOPPED"으로 변경

자동 소멸 메시지(auto_dismiss: 1000):

"물리적 비상정지 버튼이 활성화되어 있습니다. 버튼을 해제해주세요."
"이미 작동 중입니다"
"비상 상황 해결 후 다시 시도하세요"
"하드웨어 연결 오류"