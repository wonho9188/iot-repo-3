SC_04. 창고 온도 모니터링 및 제어 시나리오
트리거:
정기적(5초 간격) 환경 센서 측정 또는 관리자의 온도 설정 변경
참여자:
Env Controller AB/CD, TCP Handler, Service Layer, DB, GUI(Flask)
Flow:
1. 환경 데이터 수집 및 전송

Env Controller AB는 주기적으로 창고 A, B의 온도 측정
Env Controller CD는 주기적으로 창고 C, D의 온도 측정
각 컨트롤러는 측정값을 TCP 메시지로 서버에 전송
메시지에는 device 식별자, 각 창고별 온도 값 포함
TCP Handler가 메시지를 수신하여 Service Layer로 전달

2. 데이터 처리 및 임계값 확인

Service Layer는 각 창고의 측정값과 설정된 적정 범위 비교:

냉동 창고(A): 온도(-18~-30℃)
냉장 창고(B): 온도(0~10℃)
상온 창고(C): 온도(15~25℃)
비식품창고(D): 온도(15~25℃)


데이터 저장 최적화:

이상치 발생 시에만 DB에 해당 데이터 저장 (abnormal_logs 테이블)
매 시간 단위로 각 창고별 평균 온도 계산하여 저장 (hourly_averages 테이블)


측정값의 상태 판단:

정상: 설정 범위 내
경고: 설정 범위 초과 (±4℃ 이내)
위험: 설정 범위 크게 초과 (±8℃ 초과)


상태 변경 시 이상치 로그 기록 및 DB에 저장
Socket.IO를 통해 GUI에 상태 업데이트 전송
이전 상태와 비교하여 변경되었으면 이상치 로그 기록

상태 변경 시: 해당 창고, 측정값, 이전상태→현재상태, 시간 기록
로그에는 온도 및 팬 상태 제어 정보도 포함하여 추적성 확보


Socket.IO를 통해 GUI에 즉시 상태 업데이트 전송

모든 창고의 최신 온도 데이터와 상태를 실시간으로 전송
상태가 변경되면 자동 소멸 알림 메시지 함께 전송 (1초 후 자동 소멸)


GUI는 받은 데이터를 기반으로 환경 모니터링 화면 업데이트

각 창고별 현재 온도 수치 표시
상태에 따른 색상 코드 적용 (정상: 녹색, 경고: 노란색, 위험: 빨간색)
이상 상태 발생 시 화면 상단에 경고 메시지 1초간 표시 후 자동 소멸



3. 팬 제어 명령 결정

온도에 따른 팬 제어 모드 및 세기 결정:

냉동/냉장(A, B):

기본 상태: 냉방 1단계 상시 작동 (파란색 LED ON)
온도가 기준보다 낮을 때: 난방 1단계로 전환 (빨간색 LED ON)
온도가 기준보다 높을 때: 냉방 모드, 기준치(-18°C 또는 0°C)에서 4도 차이마다 단계 증가(최대 3단계)


상온/비식품(C, D):

온도가 기준 범위 내: 팬 정지
온도가 기준보다 낮을 때: 난방 모드, 기준치(15°C)에서 4도 차이마다 단계 증가(최대 3단계)
온도가 기준보다 높을 때: 냉방 모드, 기준치(25°C)에서 4도 차이마다 단계 증가(최대 3단계)




TCP Handler를 통해 해당 Env Controller(AB 또는 CD)로 명령 전송
Env Controller는 명령 수신 후 해당 창고의 팬 속도 조절 및 LED 제어

냉방 모드: 팬 작동 + 파란색 LED ON + 빨간색 LED OFF
난방 모드: 팬 작동 + 빨간색 LED ON + 파란색 LED OFF
정지 모드: 팬 정지 + 모든 LED OFF
팬 세기는 1~3단계로 설정 (PWM 제어)


명령 처리 후 응답 메시지 전송

4. 경고 상태 처리

온도 경고/위험 상태 발생 시 해당 Env Controller로 경고 명령 전송
Env Controller는 노란색 경고 LED 및 부저 작동

온도 경고/위험: 노란색 LED 깜빡임, 부저 작동


정상 상태 복귀 시 경고 장치 비활성화 명령 전송

5. GUI 업데이트 및 표시

Socket.IO로 받은 데이터로 환경 모니터링 화면 업데이트
창고별 온도 수치 및 상태 표시:

온도 상태: 정상(녹색), 경고(노란색), 위험(빨간색)
제어 상태: 냉방(파란색 아이콘), 난방(빨간색 아이콘)


센서 오류 및 통신 장애 시 전용 아이콘 표시
상태 변경 시 경고 메시지 표시 (1초 후 자동 소멸)

선택 분기점:

온도 상태: 정상/경고/위험에 따른 제어 및 표시 방식 변경
팬 제어 모드: 냉방(파란 LED)/난방(빨간 LED)/정지에 따른 하드웨어 제어
예외 상태: 센서 오류/통신 장애 발생 시 처리 방식

예외 상황:

센서 오류: 측정값 비정상 시 이전 값 유지, 오류 표시
통신 장애: 10초 이상 데이터 미수신 시 장애 표시, 재연결 시도